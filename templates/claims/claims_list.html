{% extends "base.html" %}
{% load static %}

{% block title %}Claims List{% endblock %}

{% block content_header %}
    <!-- Banner image above the table -->
    <div class="text-center mb-4">
        <img src="{% static 'images/homeimage.jpg' %}"
             alt="Claims Home"
             class="img-fluid rounded shadow"
             style="width: 100%; height: 300px; object-fit: cover;">
    </div>
{% endblock %}

{% block content %}
<div x-data="claimsApp()" class="lazypaste-main">
    <!-- Search and Filter Section -->
    <div class="lazypaste-search-bar d-flex align-items-center gap-2 mb-3">
        <!-- Search Input -->
        <div style="position: relative; flex: 3;">
            <input 
                type="text"
                class="lazypaste-search-input form-control ps-5"
                placeholder="Search claims..."
                value="{{ search_query }}"
                hx-get="{% url 'claims:search_claims' %}"
                hx-target="#lazypaste-table-body"
                hx-trigger="keyup changed delay:300ms"
                hx-include="[name='status']"
                name="search"
            />
            <span style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #9ca3af;">
                üîç
            </span>
        </div>

        <!-- Status Filter -->
        <select 
            name="status"
            class="lazypaste-filter-btn form-select"
            hx-get="{% url 'claims:search_claims' %}"
            hx-target="#lazypaste-table-body"
            hx-include="[name='search']"
            style="max-width: 180px;"
        >
            <option value="">All</option>
            {% for value, label in status_choices %}
                <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                    {{ label }}
                </option>
            {% endfor %}
            <option value="flagged" {% if status_filter == 'flagged' %}selected{% endif %}>
                üö© Flagged
            </option>
        </select>
    </div>

    <!-- Claims Table -->
    <div class="lazypaste-table-container card shadow">
        <div class="card-body p-0">
            <table class="lazypaste-table table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Claim ID</th>
                        <th>Patient</th>
                        <th>Billed</th>
                        <th>Paid</th>
                        <th>Status</th>
                        <th>Insurer</th>
                        <th>Discharge Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="lazypaste-table-body">
                    {% include 'claims/claims_table_partial.html' %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination Controls -->
    {% if is_paginated %}
    <div class="d-flex justify-content-between align-items-center mt-4">
        <div>
            <span class="text-muted">
                Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} 
                of {{ paginator.count }} claims
            </span>
        </div>
        
        <nav aria-label="Claims pagination">
            <ul class="pagination mb-0">
                <!-- Previous page -->
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="#"
                           hx-get="{% url 'claims:search_claims' %}?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                           hx-target="#lazypaste-table-body">
                            &laquo; Previous
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">&laquo; Previous</span>
                    </li>
                {% endif %}

                <!-- Page numbers -->
                {% for num in paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="#"
                               hx-get="{% url 'claims:search_claims' %}?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                               hx-target="#lazypaste-table-body">
                                {{ num }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}

                <!-- Next page -->
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="#"
                           hx-get="{% url 'claims:search_claims' %}?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                           hx-target="#lazypaste-table-body">
                            Next &raquo;
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Next &raquo;</span>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}